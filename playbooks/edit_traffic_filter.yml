---
- name: Edit Traffic Filter profiles and protections
  hosts: cc
  gather_facts: no
  vars_files:
    - ../vars/cc.yml
    - ../vars/edit_vars.yml

  tasks:
    - block:
        - name: Lock device(s)
          dp_lock:
            provider: "{{ cc }}"
            dp_ip: "{{ item }}"
          loop: "{{ dp_ip }}"
          when: not (skip_device_lock | default(false))

        - name: Edit Traffic Filter profiles and protections
          edit_traffic_filter:
            provider: "{{ cc }}"
            dp_ip: "{{ item }}"
            traffic_filters: "{{ traffic_filters | default({}) }}"
          loop: "{{ dp_ip }}"
          loop_control:
            label: "Device: {{ item }}"
          register: traffic_filter_results
          ignore_errors: yes

        # --- FIX APPLIED HERE: Whitespace removed to ensure clean output ---
        - name: Display Traffic Filter results (cleanest, user-friendly)
          vars:
            output_lines: |
              {% set profiles = item.response.edited_profiles | default([]) %}
              {% set protections = item.response.edited_protections | default([]) %}
              {% set errors = item.response.errors | default([]) %}

              **Device: {{ item.item }}**

              {% if profiles | length > 0 %}
              **Traffic Filter Profiles Edited ({{ profiles | length }}):**
              {% for prof in profiles %}
              - **Profile Name:** {{ prof.profile_name }}
              {% if prof.user_friendly is defined %}
              {% for k, v in prof.user_friendly.items() %}
              -   {{ k | replace('_', ' ') | capitalize }}: {{ v }}
              {% endfor %}
              {% endif %}
              {% if prof.error is defined %}
              - **Error:** {{ prof.error }}
              {% endif %}
              {% endfor %}
              {% else %}
              No profiles were edited.
              {% endif %}

              {% if protections | length > 0 %}
              **Traffic Filter Protections Edited ({{ protections | length }}):**
              {% for prot in protections %}
              - **Protection Name:** {{ prot.protection_name }} (Profile: {{ prot.user_friendly.filter_profile_name | default(prot.profile_name) }})
              {% if prot.user_friendly is defined %}
              {% for k, v in prot.user_friendly.items() %}
              -   {{ k | replace('_', ' ') | capitalize }}: {{ v }}
              {% endfor %}
              {% endif %}
              {% if prot.error is defined %}
              - **Error:** {{ prot.error }}
              {% endif %}
              {% endfor %}
              {% else %}
              No protections were edited.
              {% endif %}

              {% if errors | length > 0 %}
              **Errors Detected:**
              {% for err in errors %}
              - {{ err }}
              {% endfor %}
              {% else %}
              No device-level errors detected.
              {% endif %}
          debug:
            # Splits the multi-line string into a list, which is the best way to print clean output
            msg: "{{ output_lines.split('\n') }}"
          loop: "{{ traffic_filter_results.results }}"
          loop_control:
            label: "Device: {{ item.item }}"

      always:
        - name: Unlock device(s)
          dp_unlock:
            provider: "{{ cc }}"
            dp_ip: "{{ item }}"
          loop: "{{ dp_ip }}"
          when: not (skip_device_lock | default(false))