name: Mirror to Radware
on:
  push:
    branches:
      - '**'
  delete:
    branches:
      - '**'
jobs:
  mirror:
    runs-on: ubuntu-latest
    name: Mirror branches to radware/dp_config_builder
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        if: github.event_name == 'push'
          
      - name: Setup SSH
        if: github.event_name == 'push'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          
      - name: Configure Git
        if: github.event_name == 'push'
        run: |
          git config user.name "GitHub Actions Mirror Bot"
          git config user.email "actions@github.com"
          git config core.sshCommand "ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes"
          
      - name: Mirror branch to radware (excluding workflows)
        if: github.event_name == 'push'
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Mirroring branch: $BRANCH_NAME (excluding .github/workflows)"
          
          # Create a clean branch without workflows
          git checkout -b temp-mirror-$GITHUB_SHA
          
          # Remove workflows directory
          rm -rf .github/workflows
          
          # If .github is now empty, remove it
          if [ -d .github ] && [ -z "$(ls -A .github)" ]; then
            rm -rf .github
          fi
          
          # Commit the removal (only if there are changes)
          git add -A
          git diff --staged --quiet || git commit -m "Exclude workflows for mirror"
          
          # Add remote and push
          git remote add radware git@github.com:Radware/dp_config_builder.git
          git push radware temp-mirror-$GITHUB_SHA:${BRANCH_NAME} --force
          
          echo "✓ Branch mirrored successfully without workflows"
          
      - name: Delete branch from radware
        if: github.event_name == 'delete'
        env:
          GITHUB_TOKEN: ${{ secrets.MIRROR_TOKEN }}
        run: |
          BRANCH_NAME="${{ github.event.ref }}"
          echo "Deleting branch: $BRANCH_NAME"
          
          # Make API call and capture response (silent mode, no progress bars)
          RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/Radware/dp_config_builder/git/refs/heads/${BRANCH_NAME})
          
          # Extract HTTP status code (last line)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          # Extract response body (everything except last line)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "----------------------------------------"
          echo "HTTP Status Code: $HTTP_CODE"
          echo "API Response:"
          echo "$BODY"
          echo "----------------------------------------"
          
          # Check if successful
          if [ "$HTTP_CODE" = "204" ]; then
            echo "✓ Branch successfully deleted from Radware"
            exit 0
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "✓ Branch doesn't exist in Radware (already deleted or never mirrored)"
            exit 0
          elif [ "$HTTP_CODE" = "401" ]; then
            echo "✗ Authentication failed - check MIRROR_TOKEN secret"
            exit 1
          elif [ "$HTTP_CODE" = "403" ]; then
            echo "✗ Permission denied - token lacks required permissions"
            exit 1
          else
            echo "✗ Branch deletion failed with unexpected status code"
            exit 1
          fi
